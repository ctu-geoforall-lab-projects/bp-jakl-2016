\chapter{Praktická část}
\label{3-Praktická část}

\section{server PostGIS}
\label{server PostGIS}
V rámci této bakalářské práce s daty byla zřízena databáze PostGIS na školním
serveru. Do této databáze byla nahrána verze dat z OSM pro celou Českou
Republiku. Tyto data jsou každý den pravidelně aktualizována.
Data z OSM jsou do školní databáze nahrávána pomocí programu {\tt osm2pgsql.py}.\footnote{dostupné na http://wiki.openstreetmap.org/wiki/Osm2pgsql}
Ten nejprve stáhne aktuální data pro celou evropu a následně ořeže
jen na území ČR. 

Pro každou ze tří tříd z OSM je vytvořena samostatná 
tabulka. Pro uzly je vytvořena tabulka {\tt czech\_point}.
Pro~cesty z~OSM je vztvořena tabulka {\tt czech\_line} a pro plošné 
prvky (uzavřené cesty s atributy pro plochy) je vytvořena tabulka
{\tt czech\_polygon}.

Každý prvek má přiřazen, v rámci tabulky, jedinečné číslo {\tt PID}, 
dále je vytvořena geometrie a pak pro každý atribut je stejnojmený 
sloupce s~hodnotou. 
Například bod s atributem {\tt landuse = forest} má vse sloupci 
{\tt landuse} hodnotu {\tt forest}.

Dále tato databáze bude používána pro analýzu a úpravu dat z~IPR a
pro~import do~OSM.


\section{IPR data}
\label{IPR data}
IPR na svém webu od jara roku 2015 zveřejǔne data.
U všech zveřejněných dat, které jsou ve~vektorovém formátu jsou
možnosti souborvé formáty GeoJSON, DXF, GML nebo ESRI Shapefile.
Dále je na výběr mezi dvěma kartografickými zobrazeními S-JTSK nebo WGS 84.

Celkem IPR zveřejňuje 96 druhů datových souborů a ty jsou rozděleny
do~kategorii.\footnote{www.geoportalpraha.cz/cs/opendata}

Pokud není řečeno jinak, jedná se o data ve vektorové formě.
Těmito kategoriemi jsou:

\begin{itemize}
    \item   3D model - Obsahuje 3D modely budov a mostů v Praze a digitální
            model povrchu (DMP) a dále rastrově digitální model povrhu a
            terénu, absolutní a relativní výšky budov.
    \item   Digitální technická mapa Prahy - jsou zde k dispozici v vektorové
            podobě inženýrské sítě v Praze, technické budovy a hranice parcel.
    \item   Doprava - obsahuje cyklistické trasy a značky, pěší trasy
            parkovací zóny,automaty, P+R parkoviště a mapy zon PID (vektor)
    \item   Geologie - obsahuje vektorové mapy radonového nebezpečí..
    \item   Hluk - obsauhjí hlukové mapy a to ve dne a v noci v rasterové formě.
    \item   Kvalita životního prostředí - ...
    \item   Mapové podklady - obsahuje klady mapových listů
            různých měřítek (1:500 až 1:10 000)
    \item   Občanská vybavenost
    \item   Ochrana přírody a krajiny
    \item   Ortofoto obsahují letecké snímky (rastr) Prahy až s rozlišením 5cm
            na~pixel jak ve~viditelném spektru světla tak i v infračerveném.
    \item   Ovzduší, obsauje vektorové mapy znečištění ovzduší a také
            zdoje znečištění
    \item   Platný územní plán
    \item   Socioekonomická data
    \item   Technická infrastruktura - vodní hospodářství
    \item   Urbanismus
\end{itemize}




\subsection{licenční problém}
\label{licenční problém}
Jak již bylo řečeno výše, IPR svá data zveřejnil a stále zveřejňuje pod licencí CC-BY SA 4.0 viz \ref{licence CC BY-SA 4.0}.

Jelikož jsou ale data OSM distribuována pod licencí ODbL,
době tvorby této práce, neumožňuje jejich začlenění do databíze OSM.

Licence ODbl je licence zaměřená na databáze. Zaručuje licencční 
ochranu databázi jako celku. 

Na některá data (informace), jako například místní názvy (ulice, ..)
se nemohou vzdathovat autorská práva. Nebo na infomace, která 
nevyžadovala žádnou kretivitu pro "vytvoření" . 

Vyžaduje ale vzdání se licenčních nároků 
na data, která tam uživatel přidal. V některých zemích, kde se nelze 
úplně vzdát autoriskcýh práv, vyžaduje jejich vzdání se na nejnižší 
možnou míru a také souhlasí, že nebude vymáhat svoje autorská práva.
\cite{ODbl}


IPR byl kontaktován, zdali by mohla být jeho data použita do import.
Dle vyjádření vyplinulo, že IPR by neměl problém s použitím svých dat, jelikož
jsou šířena pod myšlenkou opendata. Byla navrhnuta možnost udělit od IPR vyjímku
licenčního použití pro OSM, avšak toto by neřešilo problém, že by tato data byla
k dispožici z OSM pro koncové uživatele pod licencí ODbL. Tedy co by někteý
uživatel nemohl s daty, distribuovaných přímo od IPR, provádět mohl by si je
obstarat z databáze OSM a pod licencí, která by jeho aktivitu neomezovala.


Dle vyjádření se tato situace bude ze strany IPR řešit tak, že se změní 
licence u distribuovaných dat. Tato změna licencování se očekává 
v~několika měsících.




\section{IprDownloader}
\label{Iprdownloader}
Jak již bylo řečeno tak IPR distibuje svá data a datové soubory přímo na své 
stránce. Data tam jsou distribuována možností odkazů ke stažení nebo je
k~dispozici kanál ve formátu ATOM ({\tt http://opendata.iprpraha.cz/feed.xml}).
Pomocí něho se lze také dostat ke všem distribuovaným datům.

Jelikož by bylo zdlouhavé stahovat všechny tyto soubory ručně, proto byl
vytvořen program, který umožňuje stahování a import dat. Skript byl napsán
v~programovacím jazyce Python a využívá knihovny GDAL.

Je rozdělen na tři soubory 
{\tt , IprDownloader.py , IprBase.py} a {\tt IprPg.py}.


\subsection{{\tt IprDownloader.py}}
Na primární skript {\tt IprDowloader.py}, který parsuje vstupní údaje a
zpracovává je k~dalšímu použití ve sriptu, viz \ref{argparse} .
Těmito základními údaji jsou
({\tt ---alike, ---crs, ---format, ---outdir ---d}). Dalšími vstupními údaji mohou
údaje o databázi, kam se mají data importovat. Těmi to vstupy jsou
({\tt ---dbname ---dbschema ---dbhost ---dbport ---dbuser ---dbpassword}).

Skript hlídá vstupní formát kartografických souřadnic a pokud se neshodují
s~možnými, oznámí chybu o špatném vstupu. Pokud uživatel vloží kartografické
zobrazení ve formě EPGS kodu, program jej převede na jeho název.


\subsection{{\tt IprBase.py}}
Skript {\tt IprBase.py} definuje třídu {\tt IprDownloader} se všemy 
potřebnými funkcemi. Většina funkcí slouží pro otevírání, čtení a parsování
XML souborů, viz \ref{xmltodict} .
Obsahuje funkci pro hledání, která prochází všechny záznamy a 
porovnává, zda vstupní přibližný název je obsažen v názvu souboru dat. Poté 
najde odkaz na xml souboru a otevře jej. Následuje vždy čtení a parsování. 
Poté v naparsovaných udajích najde dle nastavení {\tt crc, format} správný soubor 
a stáhne jej do definovaného adresáře.


\subsection{{\tt IprPg.py}}
Skript {\tt IprPg.py } definuje třídou {\tt IprDownloaderPg }, která dědí 
všechny funkce od třídy {\tt IprDownloader } a definuje další funkce potřebné pro 
správný import stažených dat do databáze PostgreSQL. 
Přesněji stažený soubor zkontroluje, jestli není v kompresován v archivu 
{\tt *.zip} , jeslit ano, extrahuje ho do nové složky se stejným jménem jako
archýv ve stejném adresáři jako archiv. Následně složí string pro PostgreSQL 
ze~vstupních údajů. Pro soubory ve formátu ESRI Shapefile opravý definici 
kartografického zobrazení uloženou v souboru {\tt *.prj }. 


\section{Ovládání}
Při pouhém spuštění skriptu vypíše všechna nalezená data, která IPR dává 
k~dispozici. Pro hledání a označení, která data se mají stánout slouží 
{\tt ---alike }. Za toto uživatel připojí slovo nebo frázi, jež chce v~datech
hledat. Pro~sousloví, které obsahuje mezeru, je vhodné jej umístit do uvozovek. 
Program rozlišuje velká~x~malá písmena a háčky a čárky.

příklad:

{\tt \$ iprdownloader.py ---alike 'Technická mapa'}
  

Dále jsou k dispozici nastavení.
\begin{itemize}
    \item kartografické zobrazení {\tt ---crs } . K dispozici jsou dvě
     (S-JTSK nebo WGS-84), respektive lze vkládat čtyři různé vstupy, protože 
     lze tyto kartografická zobrazení vložit i EPGS kody (5514 a 4326). 
     Přednastavené zobrazení je S-JTSK.
    \item datová formát souborů {\tt ---format} .
    
    Pro vektorové soubory je možné zvolit pro vektorová data:
        \subitem {\tt json }  JavaScript Object Notation
        \subitem {\tt dxf  }  AutoCAD DXF
        \subitem {\tt gml  }  Geography Markup Language
        \subitem {\tt shp  }  ESRI shapefile
        
    Je předdefinován formát {\tt shp} .
         
    Pokud uživatel chce stahovat rasterová data, je potřeba změnit předdefinovaný
    formát souboru na adekvártní rastrový formát např. ({\tt tif}) atd.
    
    \item adresu adresáře na místním počítači. Je předdefinován adresář 
    {\tt /data/} ve~složce, kde je uložen samotný program.     
\end{itemize}

Pro stažení dat stačí přidat parametr {\tt ---download} .

příklad:

{\tt \$ iprdownloader.py ---alike 'Technická mapa' ---crs 4326 ---format gmp ---outdir IPR}

Pro možnost stahované datové souboury importovat rovnou do databáze PostGIS, je 
minimálně nutné zadat název databáze {\tt ---dbname }. To v případě pokud je
databáze PostGIS umístěna v lokální síti. Pokud je databáze umístěna na jiném
serveru, je nutné zadat adresu {\tt ---dbhost} a port {\tt ---dbport} . Pokud je
ještě vyžadován autorizovaný přístup, použije se přístupové jméno {\tt ---dbuser} a
heslo {\tt ---dbpassword} . Je možné zvolit si schema v databázi {\tt ---dbschema} . 
Pokud je vložen název databáze, není již potřeba používat parametr {\tt ---download} .

Příklad:

{\tt \$ iprdownloader.py ---alike 'Technická mapa' ---dbname pgis\_osm\_jakl ---dbschema IPR ---dbhost geo102.fsv.cvut.cz  ---dbport 5432 } 
 

\section{Navržená data pro import}
\label{Navržená data pro import}

Po projití všech dat bylo vyhodnocena vhodna data pro začlenění do OSM. 
\begin{itemize}
    \item   Výstupy PID, obsahuje vstupy/výstupy z metra.
    \item   Odpadní zařízení pro občany, dle IPR obsahuje sběrny odpadu. 
    \item   Cyklistická doprava - značky, dle technické dokumentace by mělo 
            obsahovat bodové značky stojanů Bikesharing.
    \item   Veřejné toalety
    \item   Parkovací automaty
    \item   Záchytná parkoviště P+R
\end{itemize}

Všechna vybraná data byla pomocí IprDownloader.py stažena a naiportována 
do~školní databáze PostGIS. Poté byl program QGIS připojen na školní databázi.
Poté byla v programu QGIS pomocí SQL SELECTu filtrována data z aktuální
verze OSM na školním serveru a z každého SELECTu byla vytvořena nová tabulka 
v PostGIS databázi na školním severu. Data byla filtrována za použití doporučených
atributů na české osm wiki. \cite{OSMfeatures}

Tyto vhodná data byla projit a porovnána s aktuálním stavem v OSM.
Byly navrženy vhodné atributy který by se ze zdrojových dat daly naplnit.
Takto navržené data byla navržena na hromadná korespondenční konverzace talk-cz.


\subsection{Výstupy PID}
\label{Výstupy PID}
V datech od IPR bylo obsaženo celkem 353 záznamů. Jednalo se o vstupy/výstupy
z~metra (dveře, schodiště a výtahy).

V OSM databázi bylo hledání v tabulce {\tt osm.czech\_points} bylo použit
atribut
\begin{verbatim}
    railway = subway_entrance
\end{verbatim}
Vytvořená tabulka z dat OSM obsahovala 236 prvků.
Po porovnání dat bylo zřejmé, že nejvíce jsou v OSM zmapovány
výstupy v centru, kde jsou posuny v řádech decimetrů až metr. V okrajových
částech města nejsou zmapovány všechny výstupy nebo chybí výstupy pro celé
stanice. Protože body vstupů do metra jsou většinou součástí linií,
není vhodné body mazat a vytvářet nové. Bylo potřeba najít mezi stávajícími body
v~OSM a IPR adekvátní dvojce. To znamená, že se jedná o body, které reprezentují 
stejnou věc v~realitě.

Ani editaci stávajících není příliš přínosné, když všechny vstupy do metra jsou
minimálně 3 metry široké a všechny změny by byly v řádů cm až dm. 
Bylo by ale vhodné přidat vsupy do metra tam, kde nejsou v databázi OSM.
Jedná se o stanice metra Zličín, Luka, Kačerov, Rajská zahrada a Černý most. 
Celkem se tedy jedná pouze o 26 bodů, které by bylo snadnější přidat ručně, 
protože vstupy jsou dostatečně zmapované jen zde není na některém uzlu atribut {\tt railway~=~subway\_entrance}


\subsection{Odpadní zařízení pro občany}
\label{Odpadní zařízení pro občany}
Data od IPR obsahují seznam 36 směrných dvorů s velmi detailním popsání co 
jakou látku přijímá, otevírací dobu, zřizovatel. 

Z OSM z tabulky {\tt osm.czech\_point} byly prvky vyfiltrovány podle hodnot 
\begin{verbatim}
    amenity = recycling
    recycling_type = centre
\end{verbatim}    
Bylo nalezeno celkem 11 prvků, a z toho bylo 6 prvků z IPR ve vzdálenosti 
100 metrů od prvků z OSM. Těchto 6 prvků bude vhodné pouze přesunout. Zbylé 
prvky je nutné v databázi OSM nově vytvořit.

Z dostupných dat z tabulky byly navrženy tyto atributy: 
\begin{verbatim}
    amenity = recycling
    recycling_type = centre
    opening_hours =
    fee =
    operator = 
    source = 
    source:loc = IPR
\end{verbatim}
Tyto navržené atributy by se naplnily daty z tabulky dat z IPR.
Otevírací doba by byla vložena do {\tt opening\_hours~= }.
Hodnoty v tomto atributu by byly formátovány dle doporučeného formátování.\footnote{http://wiki.openstreetmap.org/wiki/Key:opening\_hours}
 U atributu {\tt fee~= }
bylo navrženo {\tt free of charge for the Prague citizens} , tedy zdarma pro občany Prahy.
Hodnota {\tt operator~= } by byla ze stejnojmeného sloupce z dat IPR.
Atribut {\tt source~= } by byl ze sloupce {\tt POSKYT }.

Dále byly navrženy atributy:
\begin{verbatim}
    recycling:paper = yes
    recycling:plastic = yes
    recycling:metal = yes
    recycling:wood = yes
    recycling: ... = yes
\end{verbatim}
Podle toho co zde lze recyklovat, dle hodnoty ve sloupci {\tt odpadprije }.

\subsection{Cyklistická doprava - značky}
\label{Cyklistická doprava - značky}
V případě dat Cyklistická doprava - značky, byla data prohledána, dle IPR
uváděné hodnoty {\tt 103} ve sloupci {\tt DRUH} pro Bikeshating, bohužel žádné
takové hodnoty neobsahovaly. Import dat z této tabulky nebyl dál brán v potaz.


\subsection{Veřejné toalety}
\label{Veřejné toalety}
Datový soubor Veřejné toalety obsahuje jednu tabulku dat. V této tabulce je 
celkem 247 záznamů. U každého záznamu je uvedena lokalita, provozovatel. 
Dále je uvedena doba, po kterou je přístupný, zdali je nutné zaplatit poplatek,
jestli je bezbariérový a zdroj těchto dat.

Veřejné toalty byl v datech OSM byl vyhledán podle atribu
\begin{verbatim}
    amenity = toilets
\end{verbatim}

bylo zjištěno, toho času, 185 záznamů. Překrytí dat IPR a OSM bylo většinou
jeden bod z OSM a z IPR na tomto místě bylo, buď jeden ale posunutý, nebo
více bodů v okruhu několika metru. Na některých místech, převážně mimo centrum
Prahy a mimo linky metra, chyběli body veřejných toaletet úplně.
Bylo tedy vhodné stávající data doplnit data z IPR.

Na IPR dat z tabulky a základě doporučených atributů byly vybrány tyto atributy:
\begin{verbatim}
    acces = yes/permissive
    fee = no/yes
    wheelchair = yes/no
    opening_hours =
    operator =
    description =
    source = IPR
    source:location = IPR
\end{verbatim}
Pokud by hodnota byla {\tt fee~=~yes} připojila by se značka
\begin{verbatim}
    fee:price =
\end{verbatim}
hodnota by byla uvedena v Kč.

Hodnota u {\tt description~= } by byla hodnota ze sloupce {\tt lokalita} .
U atributu {\tt operator~= } byla navržena hodnota {\tt Hlavní Město Praha} ,
ale jen u~prvků, u~kterých je uvedeno HMP ve sloupci {\tt Operator}.
Tam kde není žádná hodnota, by se tento atribut nepřidal.



\subsection{Parkovací automaty}
\label{Parkovací automaty}
Soubor dat Parkovací automaty od IPR obsahovale celkem 452 záznamů parkovacích
automatů. Je zde uveden pouze TYP a Poskytovatel dat. Nelze tedy určit zdali
automat přijímá mimo, asi klasické, mince i bankovky, cizí měnu nebo i umožňuje
platbu platebními kartami.
Pro porovnání, byly vyhledány body z OSM s atributy:
\begin{verbatim}
    amenity = vendings_machine
    vending = parking_tickets
\end{verbatim}
Podle těchto parametrů bylo nalezeno pouze 8 bodových prvků v databázi OSM.
Pouze dva záznamy z OSM jsou v blízkosti k bodum z IPR.
Jeden je ve vzdalenosti okolo 5 metrů a druhý okolo 20 metrů. Nelze tedy určit
zda oba odkazují na stejný objekt nebo na dva různé.
Proto se původní prvky nebudou rušit. Nové prvky půjde zpětně rozlišit podle
atributu {\tt source:loc~= } .

U nově přidaných uzlů byly navrženy tyto atributy:
\begin{verbatim}
    amenity = vendings_machine
    vending = parking_tickets
    source = IPR
    source:loc = IPR
\end{verbatim}
Do hodnoty {\tt source~= } by byla použita hodnota ze sloupce {\tt POSKYT}) .
Hodnota u atributu {\tt source:loc~= } by byla použita {\tt IPR} .

\subsection{Záchytná parkoviště P+R}
\label{Záchytná parkoviště P+R}
Soubor dat Záchytná parkoviště P+R obsahoval 16 prvků.
V tabulce bohužel nejsou žádné jiné údaje, kromě polohy uložené v geometrii
a poksytovatel dat ve sloupci {\tt poskt}.

Z dat OSM byly vyhledány body pomocí atributu
\begin{verbatim}
    amenity = park_ride
\end{verbatim}
Tento atribut je stále ve fázi schvalování, tudíž nebyly nalezeny žádné záznamy.
Proto bylo vyzkoušeno hledání pomocí obecnějšího atributu
\begin{verbatim}
    amenity = parking
\end{verbatim}
Na území Prahy bylo nalezeno,toho času, 182 prvků.
Bylo vyzkoušeno hledání s přidaným atributem {\tt name~= }, který by obsahoval P+R.
Byl nalezen pouze jeden záznam.

Dále bylo vyzkoušeno hledání bodů s atributy 
\begin{verbatim}
    amenity = parking
    park_ride = yes
\end{verbatim}
Na území Prahy byl nalezen pouze jeden prvek.

Je tedy navrženo importovat všechny prvky z databáze IPR.
Navržené atributy jsou
\begin{verbatim}
    amenity = parking
    park_ride = yes
    source = HMP-URM
    source:loc = IPR
\end{verbatim}


\section{Návrhy z Talk-cz}
\label{Návrhy z Talk-cz}
Výše zmíněné návrhy byly takto zveřejněny a podrobeny diskuzi.

Výše zmíněná data byla zpracována v programu QGIS pomocí 
SQL. Byly vytvořeny, pro každý soubor, jedna tabulka připravená pro import.
Vždy pro každý atribut byl jeden sloupec (column) a příslužná hodnota atribut 
byla hodnota v tomto sloupci.
Každá tabulka mimo navržených atributů obsahovla sloupce s geometrii. 

Pro import  bude použit program osmosis.

Dále byly v diskuzi navrženo přidání výšky budov ze souboru dat Budovy 3D.

\subsection{Budovy 3D - výšky budov}
\label{Budovy 3D - výšky budov}
V diskuzi byla navržen import výšek budov {\tt building:height~= }
ze~sourbu dat Budovy 3D. 
A navržen atribut zdroje {\tt source:building:level~= }

..rešerše z OSM ..??

V souboru Budodvy 3D jsou uložny 3D polygonu tvoříci budovy.
Vždy polygony, které vytvářejí 3D model jedné budovy, 
mají stejnou bodnotu ve sloupci {\tt id\_bud} . 
Polygony se stejnou hodnotou {\tt id\_bud} lze dále rozdělit dle hodnoty 
ve~sloupci {\tt typ} na 
 
\begin{verbatim}
    dilci plocha stresni kruhove plochy
    komin
    sikma stresni plocha
    svisla obvodova stena
    vikyr_stresni nadstavba
    vytah_vetrani_klimatizace
    vodorovna stresni plocha
    vyznacena vez na strese
    zakladna vikyre, stresni nadstavby
    zakladova deska
 .. a další
\end{verbatim}

V 3D geometrii těchto polygonů budov jsou uloženy všechny (x,y,z) souřadnice 
vrcholů, jenž určují polygon. 

Pro nalezeni výšky budovy bylo dále pracováno pouze s polygony 
{\tt svisla obvodova stena}. 
Pro nalezení výšky každé stěny byly použity funkce pro hledání 
maximaní a minimální hodnoty z-ové souřadnice vrcholů.
Výška byla vypočtena jako jako rozdíl těchto hodnot. 

Přesněji bylo vypočtena takto {\tt ST\_ZMax(geom)-ST\_ZMin(geom) as height} 

Jelikož ale svislé stěny budovy může tvořit více než 4 polygony a 
ne všechny nemusí mít stejnou hodnotu (výšku), bula z těchto hodnot 
pro každou svislou stěnu vybrána maximální hodnota. Vždy v rámci jedné budovy. 
Tedy byla vybrána maximální hodnota výšky stěny budovy.
